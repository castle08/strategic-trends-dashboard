{
  "name": "test_v5_with_images",
  "nodes": [
    {
      "parameters": {
        "numberInputs": 5
      },
      "id": "068e2628-7c82-4283-a88f-0f9873249071",
      "name": "Merge RSS Sources",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        768,
        816
      ]
    },
    {
      "parameters": {
        "jsCode": "// Process Articles for Strategic Trend Analysis\n\nconst TZ = 'Europe/London';\nconst MIN_TITLE_LEN = 10;\nconst MIN_SUMMARY_LEN = 30;\nconst MAX_ITEMS = 100;\nconst LOOKBACK_DAYS = 7;\n\nconst BRAND_TAGS = ['retail','sportswear','energy drinks'];\nconst REGION = 'UK';\nconst LIMITS = { max_items: 20, min_confidence: 40 };\n\nfunction stripHtml(s='') {\n  return (s || '')\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, '')\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, '')\n    .replace(/<[^>]+>/g, '')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\nfunction hostFromUrl(u='') { try { return new URL(u).hostname.replace(/^www\\./,''); } catch { return ''; } }\nfunction toISO(d) {\n  if (!d) return null;\n  const tryDates = Array.isArray(d) ? d : [d];\n  for (const raw of tryDates) {\n    const t = raw ? Date.parse(raw) : NaN;\n    if (!Number.isNaN(t)) return new Date(t).toISOString();\n  }\n  return null;\n}\nfunction withinLookback(iso) {\n  if (!iso) return false;\n  const now = new Date();\n  const then = new Date(now); then.setDate(now.getDate() - LOOKBACK_DAYS);\n  return new Date(iso) >= then;\n}\nfunction normTitle(s='') { return s.toLowerCase().replace(/\\s+/g,' ').trim(); }\n\nconst inputItems = $input.all();\n\n// Flatten RSS outputs\nlet raw = [];\nfor (const it of inputItems) {\n  if (Array.isArray(it.json?.items)) raw = raw.concat(it.json.items);\n  else raw.push(it.json);\n}\n\n// Normalize articles for trend analysis\nconst normalised = [];\nfor (const r of raw) {\n  const title = (r.title || r.headline || '').trim();\n  const url = (r.link || r.url || r.guid || '').trim();\n  const summary = stripHtml(r.description || r.contentSnippet || r.summary || r.content || '');\n  const publishedAt = toISO([r.isoDate, r.pubDate, r.published, r.updated, r.date]) || new Date().toISOString();\n  \n  // Simplified source detection for trend context\n  let source = 'Market Intelligence';\n  const host = hostFromUrl(url);\n  if (host.includes('adweek')) source = 'Adweek';\n  else if (host.includes('campaignlive')) source = 'Campaign';\n  else if (host.includes('reddit.com')) source = 'Reddit';\n\n  if (title.length < MIN_TITLE_LEN) continue;\n  if (summary.length < MIN_SUMMARY_LEN) continue;\n  if (!withinLookback(publishedAt)) continue;\n\n  normalised.push({ title, summary, source, publishedAt });\n}\n\n// Dedupe by title similarity\nconst seenTitles = new Set(); const deduped = [];\nfor (const it of normalised) {\n  const key = normTitle(it.title);\n  if (seenTitles.has(key)) continue;\n  seenTitles.add(key);\n  deduped.push(it);\n}\n\n// Sort and limit\ndeduped.sort((a,b) => new Date(b.publishedAt) - new Date(a.publishedAt));\nconst items = deduped.slice(0, MAX_ITEMS);\n\nconsole.log(`ðŸ“Š Processing ${items.length} articles for strategic trend extraction`);\nconsole.log(`ðŸŽ¯ Target: Extract ${LIMITS.max_items} strategic trends for advertising agencies`);\n\n// Create analysis summary for agent\nconst articleSummary = items.map(item => `\"${item.title}\" - ${item.summary.substring(0, 200)}...`).join('\\n\\n');\n\nreturn [{\n  json: {\n    articleSummary,\n    articleCount: items.length,\n    sources: [...new Set(items.map(i => i.source))],\n    brand_tags: BRAND_TAGS,\n    region: REGION,\n    limits: LIMITS\n  }\n}];"
      },
      "id": "004e2c5a-8584-4cd7-8062-b3f44f3e8fb9",
      "name": "Process Articles",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        992,
        864
      ]
    },
    {
      "parameters": {
        "model": "gpt-4o",
        "options": {}
      },
      "id": "503af695-95bc-40bb-92aa-72259f55c7b0",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        1248,
        1088
      ],
      "credentials": {
        "openAiApi": {
          "id": "EJ4bHf6JFSTiAvix",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchema": "{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"type\": \"object\",\n  \"required\": [\"trends\", \"generatedAt\", \"sourceSummary\"],\n  \"properties\": {\n    \"generatedAt\": { \n      \"type\": \"string\",\n      \"description\": \"ISO timestamp when trends were generated\"\n    },\n    \"sourceSummary\": {\n      \"type\": \"object\",\n      \"required\": [\"totalFetched\", \"afterCluster\", \"sources\"],\n      \"properties\": {\n        \"totalFetched\": { \n          \"type\": \"number\",\n          \"description\": \"Total number of articles fetched\"\n        },\n        \"afterCluster\": { \n          \"type\": \"number\",\n          \"description\": \"Number of articles after clustering\"\n        },\n        \"sources\": { \n          \"type\": \"array\", \n          \"items\": { \"type\": \"string\" },\n          \"description\": \"List of source names\"\n        }\n      }\n    },\n    \"trends\": {\n      \"type\": \"array\",\n      \"minItems\": 10,\n      \"maxItems\": 20,\n      \"description\": \"Array of strategic trends\",\n      \"items\": {\n        \"type\": \"object\",\n        \"required\": [\"id\", \"title\", \"summary\", \"category\", \"scores\", \"whyItMatters\", \"tags\", \"brandAngles\", \"exampleUseCases\", \"creative\", \"viz\"],\n        \"properties\": {\n          \"id\": { \n            \"type\": \"string\",\n            \"description\": \"Unique trend identifier\"\n          },\n          \"title\": { \n            \"type\": \"string\",\n            \"description\": \"Strategic trend title\",\n            \"minLength\": 10\n          },\n          \"summary\": { \n            \"type\": \"string\",\n            \"description\": \"Brief trend summary\",\n            \"minLength\": 20\n          },\n          \"category\": { \n            \"type\": \"string\",\n            \"enum\": [\"Technology\", \"Media\", \"Culture\", \"Retail\", \"AI\", \"Consumer Behaviour\", \"Creativity\", \"Regulation\", \"Data & Privacy\", \"Sustainability\"],\n            \"description\": \"Trend category\"\n          },\n          \"tags\": { \n            \"type\": \"array\", \n            \"items\": { \"type\": \"string\" },\n            \"description\": \"Related tags\"\n          },\n          \"scores\": {\n            \"type\": \"object\",\n            \"required\": [\"novelty\", \"velocity\", \"relevance\", \"confidence\", \"total\"],\n            \"properties\": {\n              \"novelty\": { \n                \"type\": \"integer\", \n                \"minimum\": 1, \n                \"maximum\": 100,\n                \"description\": \"How new is this trend\"\n              },\n              \"velocity\": { \n                \"type\": \"integer\", \n                \"minimum\": 1, \n                \"maximum\": 100,\n                \"description\": \"How fast is this trend gaining momentum\"\n              },\n              \"relevance\": { \n                \"type\": \"integer\", \n                \"minimum\": 1, \n                \"maximum\": 100,\n                \"description\": \"How much will this impact advertising agencies\"\n              },\n              \"confidence\": { \n                \"type\": \"integer\", \n                \"minimum\": 1, \n                \"maximum\": 100,\n                \"description\": \"How certain are we this trend is real\"\n              },\n              \"total\": { \n                \"type\": \"integer\", \n                \"minimum\": 1, \n                \"maximum\": 100,\n                \"description\": \"Weighted average score\"\n              }\n            }\n          },\n          \"whyItMatters\": { \n            \"type\": \"string\",\n            \"description\": \"Why this trend matters for agencies\",\n            \"minLength\": 20\n          },\n          \"brandAngles\": { \n            \"type\": \"array\", \n            \"items\": { \"type\": \"string\" },\n            \"description\": \"Brand opportunities from this trend\"\n          },\n          \"exampleUseCases\": { \n            \"type\": \"array\", \n            \"items\": { \"type\": \"string\" },\n            \"description\": \"Example use cases for agencies\"\n          },\n          \"creative\": {\n            \"type\": \"object\",\n            \"required\": [\"shortCardCopy\", \"imagePrompt\", \"altText\", \"podcastSnippet\"],\n            \"properties\": {\n              \"shortCardCopy\": { \n                \"type\": \"string\", \n                \"maxLength\": 140,\n                \"description\": \"Short copy for cards\"\n              },\n              \"imagePrompt\": { \n                \"type\": \"string\",\n                \"description\": \"Prompt for generating trend image\"\n              },\n              \"altText\": { \n                \"type\": \"string\",\n                \"description\": \"Alt text for trend image\"\n              },\n              \"podcastSnippet\": { \n                \"type\": \"string\",\n                \"description\": \"Snippet for podcast content\"\n              }\n            }\n          },\n          \"viz\": {\n            \"type\": \"object\",\n            \"required\": [\"size\", \"intensity\", \"colorHint\"],\n            \"properties\": {\n              \"size\": { \n                \"type\": \"number\",\n                \"minimum\": 1,\n                \"maximum\": 20,\n                \"description\": \"Visual size for 3D rendering\"\n              },\n              \"intensity\": { \n                \"type\": \"number\",\n                \"minimum\": 0.5,\n                \"maximum\": 3.0,\n                \"description\": \"Animation intensity\"\n              },\n              \"colorHint\": { \n                \"type\": \"string\",\n                \"description\": \"CSS color hint for category\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}"
      },
      "id": "31f8d2b4-79aa-444a-88a0-7495ad9d2a56",
      "name": "Structured Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1,
      "position": [
        1376,
        1088
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "You are TrendMaker, a strategic trend analyst for advertising agencies. \n\nAnalyze these {{ $json.articleCount }} recent marketing articles and extract strategic trends:\n\n{{ $json.articleSummary }}\n\nYour job is to identify strategic market trends that will help advertising agencies win business and serve clients better. \n\n**Generate exactly 10-15 strategic trends** - not article summaries, but broader market movements and transformations.\n\nEach trend should:\n- Have a strategic trend title (e.g., \"AI-Powered Creative Automation Reaches Mass Adoption\")\n- Focus on industry transformations, not individual company news\n- Help agencies understand where the market is heading\n- Be scored 1-100 on novelty, velocity, relevance, and confidence",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are TrendMaker, a strategic trend analyst. Your job is to identify broader market trends from articles, NOT summarize individual articles.\n\n### CRITICAL: Create Strategic Trends, Not Article Summaries\n- Analyze patterns across articles to identify strategic market movements\n- Create trend titles that capture broader transformations (e.g. \"Privacy-First Marketing Becomes Competitive Advantage\")\n- Focus on what these articles collectively tell us about where the industry is heading\n- Generate insights that help agencies anticipate market changes\n\n### Requirements:\n- Generate EXACTLY 10-15 strategic trends (minimum 10)\n- All scores must be integers 1-100\n- Each trend represents a strategic market movement, not an individual article\n- Trends should help agencies win business and serve clients better\n- No URLs needed - these are strategic insights, not article links\n\n### Scoring (1-100):\n- novelty: How new is this trend vs established practice\n- velocity: How fast is this trend gaining momentum  \n- relevance: How much will this impact advertising agencies\n- confidence: How certain are we this trend is real\n- total: weighted average\n\n### Categories: \nTechnology, Media, Culture, Retail, AI, Consumer Behaviour, Creativity, Regulation, Data & Privacy, Sustainability\n\n### Trend Examples:\n- \"Retail Media Networks Challenge Traditional Display Advertising\"\n- \"Creator Economy Professionalizes Into Enterprise Marketing Channel\"\n- \"AI Content Generation Forces Creative Industry Restructuring\"\n\nReturn ONLY valid JSON matching the schema."
        }
      },
      "id": "91c242cb-09ef-4af5-9c90-3847c5dad73a",
      "name": "Strategic Trend Analyzer",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1216,
        864
      ]
    },
    {
      "parameters": {
        "jsCode": "// Finalize strategic trends for visualization\n\nconst data = $json;\nconst trends = Array.isArray(data.trends) ? data.trends : [];\n\n// Ensure minimum trend count\nif (trends.length < 10) {\n  throw new Error(`Only ${trends.length} trends generated. Minimum required: 10`);\n}\n\n// Fix sourceSummary structure\nif (!data.sourceSummary || !Array.isArray(data.sourceSummary.sources)) {\n  data.sourceSummary = {\n    totalFetched: trends.length,\n    afterCluster: trends.length,\n    sources: ['Strategic Market Intelligence']\n  };\n}\n\n// Enhanced viz properties for strategic trends\nfor (let i = 0; i < trends.length; i++) {\n  const trend = trends[i];\n  \n  if (trend.scores) {\n    const totalScore = trend.scores.total || 50;\n    const velocity = trend.scores.velocity || 50;\n    const novelty = trend.scores.novelty || 50;\n    \n    // Enhanced size mapping (10-20 for strategic importance)\n    trend.viz = trend.viz || {};\n    trend.viz.size = Math.max(10, Math.min(20, Math.round(10 + (totalScore / 100) * 10)));\n    \n    // Enhanced intensity based on velocity + novelty\n    const intensityScore = (velocity + novelty) / 2;\n    trend.viz.intensity = Number((1.2 + (intensityScore / 100) * 1.8).toFixed(2));\n    \n    // Strategic category colors\n    const cat = (trend.category || 'Technology').toLowerCase();\n    let hue;\n    switch(cat) {\n      case 'technology': case 'ai': hue = 240; break; // Blue\n      case 'media': case 'culture': hue = 300; break; // Purple  \n      case 'retail': case 'consumer behaviour': hue = 120; break; // Green\n      case 'creativity': hue = 60; break; // Yellow\n      case 'regulation': case 'data & privacy': hue = 0; break; // Red\n      case 'sustainability': hue = 150; break; // Teal\n      default: hue = 210; // Default blue\n    }\n    trend.viz.colorHint = `hsl(${hue}, 80%, 50%)`;\n    \n    // Add unique trend ID if missing - use 0-based indexing for matching\n    if (!trend.id) {\n      trend.id = i; // Use 0-based indexing to match pairedItem.item\n    } else {\n      // Convert existing string ID to number if needed\n      trend.id = parseInt(trend.id) || i;\n    }\n  }\n}\n\ndata.generatedAt = data.generatedAt || new Date().toISOString();\n\n// Strategic logging\nconsole.log(`ï¿½ï¿½ Generated ${trends.length} strategic trends for agency intelligence`);\nconst scoreRange = trends.map(t => t.scores?.total || 0);\nconst minScore = Math.min(...scoreRange);\nconst maxScore = Math.max(...scoreRange);\nconsole.log(`ðŸ“Š Strategic Impact Range: ${minScore}-${maxScore}`);\nconsole.log(`ï¿½ï¿½ Categories: ${[...new Set(trends.map(t => t.category))].join(', ')}`);\n\ntrends.slice(0, 5).forEach((trend, i) => {\n  console.log(`${i+1}. \"${trend.title}\" (${trend.category}) - Impact: ${trend.scores?.total}`);\n});\n\nreturn [{ json: data }];"
      },
      "id": "ff627ad9-b80d-47ff-bac9-6aea8bdc6a49",
      "name": "Finalize Trends",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        864
      ]
    },
    {
      "parameters": {
        "jsCode": "// Generate detailed image prompts for each trend using the template from imageprompt.md\n// This node should be inserted between \"Finalize Trends\" and the OpenAI image generation node\n\nconst inputData = $json;\nconst trends = Array.isArray(inputData.trends) ? inputData.trends : [];\n\nconsole.log(`ðŸŽ¨ Generating image prompts for ${trends.length} trends...`);\n\n// ===== TESTING CONTROLS =====\n// ðŸ§ª FOR TESTING: Set to true to only process 2 trends (faster)\nconst TESTING_MODE = true;\nconst TESTING_LIMIT = 2;\n\n// ðŸš€ FOR PRODUCTION: Set to false to process all trends\n// const TESTING_MODE = false;\n\n// Apply testing limit if enabled\nconst trendsToProcess = TESTING_MODE \n  ? trends.slice(0, TESTING_LIMIT) \n  : trends;\n\nconsole.log(`ï¿½ï¿½ Processing ${trendsToProcess.length} trends ${TESTING_MODE ? '(TESTING MODE)' : '(FULL PRODUCTION)'}`);\n\n// Process each trend to create detailed image prompts\nconst processedTrends = trendsToProcess.map((trend, index) => {\n  const { title, category, creative, viz } = trend;\n  \n  // Use the existing imagePrompt as the base, or create one from the title\n  const basePrompt = creative?.imagePrompt || `a 3D wireframe floating island`;\n  \n  // Get the category color (use existing viz.colorHint or generate from category)\n  const getCategoryColor = (cat) => {\n    const categoryLower = (cat || 'Technology').toLowerCase();\n    switch(categoryLower) {\n      case 'technology': case 'ai': return '#3b82f6'; // Blue\n      case 'media': case 'culture': return '#8b5cf6'; // Purple  \n      case 'retail': case 'consumer behaviour': return '#10b981'; // Green\n      case 'creativity': return '#f59e0b'; // Yellow/Orange\n      case 'regulation': case 'data & privacy': return '#ef4444'; // Red\n      case 'sustainability': return '#06b6d4'; // Teal\n      default: return '#3b82f6'; // Default blue\n    }\n  };\n  \n  const categoryColor = viz?.colorHint || getCategoryColor(category);\n  \n  // Create the detailed prompt using the template from imageprompt.md\n  const detailedPrompt = `Create a hyper-detailed, high quality render of ${basePrompt} representing \"${title}\" in the ${category} category.\n\nStyle:\nâ€¢ Clean 3D wireframe with thin, glowing lines and geometric shapes\nâ€¢ Symbolism: Include visual elements symbolizing the trend theme \"${title}\" and its significance in ${category}\nâ€¢ Materials: Transparent surfaces with visible wireframe edges\nâ€¢ Primary color tone: Use ${categoryColor} (hex color) prominently in lighting, accents, and key elements\nâ€¢ Lighting: Subtle glow along the wireframe lines with ${categoryColor} color\nâ€¢ Background: Transparent PNG with alpha channel (no sky or scenery)\nâ€¢ Format: 1024x1024 PNG with transparent background`;\n\n  console.log(`ðŸ“ Generated prompt for \"${title}\": ${detailedPrompt.substring(0, 100)}...`);\n  \n  return {\n    ...trend,\n    imageGenerationPrompt: detailedPrompt\n  };\n});\n\nconsole.log(`âœ… Generated ${processedTrends.length} image prompts`);\n\nreturn [{\n  json: {\n    ...inputData,\n    trends: processedTrends\n  }\n}];"
      },
      "id": "1f49d0cc-a19f-4edf-a232-083e111d40d4",
      "name": "Generate Image Prompts",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        864
      ]
    },
    {
      "parameters": {
        "jsCode": "// Split trends into individual items for image generation\n// This node creates separate items for each trend so the LangChain OpenAI node can process them individually\n\nconst inputData = $json;\nconst trends = Array.isArray(inputData.trends) ? inputData.trends : [];\n\nconsole.log(`ðŸ”„ Splitting ${trends.length} trends into individual items for image generation...`);\n\n// Process ALL trends for images\nconst trendsToProcess = trends;\nconsole.log(`ðŸ“Š Processing all ${trendsToProcess.length} trends for image generation`);\n\n// Create separate items for each trend to process\n// For LangChain OpenAI node, we need to structure the data differently\nconst individualTrends = trendsToProcess.map(trend => ({\n  json: {\n    trend: {\n      ...trend,\n      imageGenerationPrompt: trend.imageGenerationPrompt\n    },\n    trendId: trend.id,\n    trendTitle: trend.title\n  }\n}));\n\nconsole.log(`âœ… Created ${individualTrends.length} individual trend items for image generation`);\n\nreturn individualTrends;\n"
      },
      "id": "d2323ed2-b825-44f3-8a74-ddd1d43e1787",
      "name": "Split Trends for Image Generation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        864
      ]
    },
    {
      "parameters": {
        "jsCode": "// Process image files and convert to base64 for direct storage\nconst inputItems = $input.all();\n\nconsole.log(`ðŸ–¼ï¸ Processing ${inputItems.length} items for base64 conversion...`);\n\nconst imageData = [];\ninputItems.forEach((item, index) => {\n  console.log(`\\nï¿½ï¿½ Processing item ${index + 1}:`);\n  console.log(`Item keys:`, Object.keys(item || {}));\n  \n  if (item.binary && item.binary.data) {\n    // Convert binary data to base64\n    const base64 = btoa(String.fromCharCode(...new Uint8Array(item.binary.data)));\n    imageData.push({\n      index: index,\n      base64: base64,\n      mimeType: 'image/png',\n      size: item.binary.data.byteLength\n    });\n    console.log(`âœ… Converted item ${index + 1} to base64 (${item.binary.data.byteLength} bytes)`);\n  } else {\n    console.log(`âŒ No binary data found for item ${index + 1}`);\n    imageData.push(null);\n  }\n});\n\nconsole.log(`\\nðŸ“Š Converted ${imageData.filter(d => d).length} images to base64`);\n\nreturn [{\n  json: {\n    imageData: imageData,\n    successfulConversions: imageData.filter(d => d).length,\n    totalItems: inputItems.length,\n    generatedAt: new Date().toISOString()\n  }\n}];"
      },
      "id": "a08379c8-91a7-425d-9f30-7402bf8a9944",
      "name": "Process Image Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        1472
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://trends-dashboard-six.vercel.app/api/trends-with-storage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {
          "allowUnauthorizedCerts": false,
          "timeout": 10000
        }
      },
      "id": "3975233a-7da3-4eb0-b3a0-585bf106240b",
      "name": "Update Live Dashboard",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        320,
        1696
      ],
      "continueOnFail": true,
      "notes": "Posts trends data to live Vercel dashboard API - Both 3D dashboard and screens mode will get updated automatically"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24
            }
          ]
        }
      },
      "id": "7979a0e9-5b5c-485a-ac0d-325c8fca87f6",
      "name": "Daily Intelligence Update",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        320,
        768
      ]
    },
    {
      "parameters": {
        "url": "https://www.campaignlive.co.uk/rss/news",
        "options": {}
      },
      "id": "c63f64e4-38e5-4a4a-9bf7-07fd5449ed4b",
      "name": "campaignlive - news",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        544,
        480
      ]
    },
    {
      "parameters": {
        "url": "https://www.campaignlive.co.uk/rss/latest",
        "options": {}
      },
      "id": "88774575-4f3f-4de5-b93e-9a4b305db9e1",
      "name": "campaignlive - latest",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        544,
        672
      ]
    },
    {
      "parameters": {
        "url": "https://www.adweek.com/feed/",
        "options": {}
      },
      "id": "7b4b751b-2f7c-4b74-bb5c-edf6ba28903f",
      "name": "adweek",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        544,
        864
      ]
    },
    {
      "parameters": {
        "url": "https://www.reddit.com/r/advertising/.rss",
        "options": {}
      },
      "id": "02228f7c-bbc7-4af3-b813-83126a6bec8b",
      "name": "reddit - advertising",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        544,
        1056
      ]
    },
    {
      "parameters": {
        "url": "https://www.reddit.com/r/marketing/.rss",
        "options": {}
      },
      "id": "5432e9c4-ff71-4de7-acf5-5d7b6cddd89e",
      "name": "reddit - marketing",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        544,
        1248
      ]
    },
    {
      "parameters": {
        "resource": "image",
        "model": "gpt-image-1",
        "prompt": "={{ $json.trend.imageGenerationPrompt }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2288,
        1008
      ],
      "id": "283948e1-fa7d-4487-b578-313d2e1235e4",
      "name": "Generate an image",
      "credentials": {
        "openAiApi": {
          "id": "EJ4bHf6JFSTiAvix",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Debug node to see exactly what the LangChain OpenAI node returns\n// This will help us understand the data structure\n\nconst inputItems = $input.all();\n\nconsole.log(`ðŸ” Debug: Processing ${inputItems.length} items from OpenAI node`);\n\n// Log each item in detail\ninputItems.forEach((item, index) => {\n  console.log(`\\nðŸ“‹ Item ${index + 1}:`);\n  console.log(`Type: ${typeof item.json}`);\n  console.log(`Keys: ${Object.keys(item.json || {}).join(', ')}`);\n  console.log(`Full JSON:`, JSON.stringify(item.json, null, 2));\n  \n  // Check if it's a string that might be a URL\n  if (typeof item.json === 'string') {\n    console.log(`String content: ${item.json.substring(0, 100)}...`);\n    if (item.json.startsWith('http')) {\n      console.log(`âœ… Found URL: ${item.json}`);\n    }\n  }\n  \n  // Check nested structures\n  if (item.json && typeof item.json === 'object') {\n    if (item.json.data) {\n      console.log(`Data object:`, JSON.stringify(item.json.data, null, 2));\n    }\n    if (item.json.result) {\n      console.log(`Result:`, item.json.result);\n    }\n    if (item.json.url) {\n      console.log(`URL:`, item.json.url);\n    }\n  }\n});\n\n// Try to extract any URLs we can find\nconst foundUrls = [];\ninputItems.forEach((item, index) => {\n  let url = null;\n  \n  // Check all possible locations\n  if (typeof item.json === 'string' && item.json.startsWith('http')) {\n    url = item.json;\n  } else if (item.json && item.json.url) {\n    url = item.json.url;\n  } else if (item.json && item.json.data && item.json.data.url) {\n    url = item.json.data.url;\n  } else if (item.json && item.json.result) {\n    url = item.json.result;\n  } else if (item.json && item.json.imageUrl) {\n    url = item.json.imageUrl;\n  }\n  \n  if (url) {\n    console.log(`âœ… Found URL for item ${index + 1}: ${url}`);\n    foundUrls.push(url);\n  } else {\n    console.log(`âŒ No URL found for item ${index + 1}`);\n    foundUrls.push(null);\n  }\n});\n\nconsole.log(`\\nðŸ“Š Summary: Found ${foundUrls.filter(url => url).length} URLs out of ${foundUrls.length} items`);\n\nreturn [{\n  json: {\n    debug: {\n      totalItems: inputItems.length,\n      foundUrls: foundUrls.filter(url => url).length,\n      urls: foundUrls,\n      message: \"Check console logs for detailed debug information\"\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        1920
      ],
      "id": "394a9b70-b458-439e-a559-1eca53eb9aba",
      "name": "Debug Code"
    },
    {
      "parameters": {
        "mode": "combine",
        "advanced": true,
        "mergeByFields": {
          "values": [
            {
              "field1": "trendId",
              "field2": "imageId"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2960,
        848
      ],
      "id": "bc9ccd6e-57f8-4deb-8068-00069042c2f8",
      "name": "Merge1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "binaryToPropery",
        "destinationKey": "base64Image",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        2512,
        1008
      ],
      "id": "ac39089e-83ce-4338-b910-9b193ace51ca",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "jsCode": "// Debug: Check trendId values and types\nconst items = $input.all();\nconsole.log('ðŸ” Split Trends - trendId values:');\nitems.forEach((item, index) => {\n  console.log(`Item ${index}: trendId = ${item.trendId} (type: ${typeof item.trendId})`);\n});\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2288,
        624
      ],
      "id": "532cafc5-22f9-455c-9be3-ad5e60f3546e",
      "name": "Code1"
    },
    {
      "parameters": {
        "jsCode": "// Add imageId to match with trendId (avoiding reserved pairedItem key)\nconst items = $input.all();\nconsole.log(`ï¿½ï¿½ Processing ${items.length} items`);\n\nconst processedItems = items.map((item, index) => {\n  console.log(`ðŸ“¸ Item ${index} input:`, Object.keys(item));\n  \n  // Use imageId instead of pairedItem to avoid reserved key\n  const newItem = {\n    imageBinary: item.json.base64Image, // Extract from json wrapper\n    imageId: index // This will match with trendId\n  };\n  \n  console.log(`âœ… Item ${index} output:`, Object.keys(newItem));\n  return newItem;\n});\n\nconsole.log(`âœ… Processed ${processedItems.length} items`);\nreturn processedItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2736,
        912
      ],
      "id": "eb093d57-f265-46ea-a3a0-d6850f58e0da",
      "name": "Code2"
    },
    {
      "parameters": {
        "jsCode": "// Debug: Check what Extract from File actually outputs\nconst items = $input.all();\nconsole.log('ðŸ” Extract from File - Full structure:');\nitems.forEach((item, index) => {\n  console.log(`Item ${index}:`, JSON.stringify(item, null, 2));\n  console.log(`Item ${index} keys:`, Object.keys(item));\n  console.log(`Item ${index} has base64Image:`, 'base64Image' in item);\n  console.log(`Item ${index} base64Image length:`, item.base64Image ? item.base64Image.length : 0);\n});\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2736,
        1104
      ],
      "id": "a589d1f1-2fac-49a8-babc-45ec29f1c03b",
      "name": "Code3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://trends-dashboard-six.vercel.app/api/trends-with-storage",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3632,
        848
      ],
      "id": "cb57c565-4104-4fbb-80c1-f39607368d80",
      "name": "Send Individual Trends to API"
    },
    {
      "parameters": {
        "jsCode": "// Transform data for individual API requests\nconst inputItems = $input.all();\n\nconsole.log(` Processing ${inputItems.length} merged items for individual API requests...`);\n\n// Transform each item to the expected API format and return individually\nconst apiData = inputItems.map(item => ({\n  trends: [{\n    ...item.json.trend,  // Spread the trend properties directly\n    imageBinary: item.json.imageBinary\n  }]\n}));\n\nconsole.log(`âœ… Created ${apiData.length} individual API payloads`);\n\n// Return each item separately so HTTP Request processes them individually\nreturn apiData.map(data => ({ json: data }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3184,
        848
      ],
      "id": "425a6a05-7998-4618-991e-b17abc2ae91c",
      "name": "Prepare API Data"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3408,
        848
      ],
      "id": "bf5cdc09-4f27-4273-97b4-2b12edac4f05",
      "name": "Loop Over Items"
    }
  ],
  "pinData": {},
  "connections": {
    "Merge RSS Sources": {
      "main": [
        [
          {
            "node": "Process Articles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Articles": {
      "main": [
        [
          {
            "node": "Strategic Trend Analyzer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Strategic Trend Analyzer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Strategic Trend Analyzer",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Strategic Trend Analyzer": {
      "main": [
        [
          {
            "node": "Finalize Trends",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Trends": {
      "main": [
        [
          {
            "node": "Generate Image Prompts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Image Prompts": {
      "main": [
        [
          {
            "node": "Split Trends for Image Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Trends for Image Generation": {
      "main": [
        [
          {
            "node": "Generate an image",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Image Results": {
      "main": [
        []
      ]
    },
    "Daily Intelligence Update": {
      "main": [
        [
          {
            "node": "campaignlive - news",
            "type": "main",
            "index": 0
          },
          {
            "node": "campaignlive - latest",
            "type": "main",
            "index": 0
          },
          {
            "node": "adweek",
            "type": "main",
            "index": 0
          },
          {
            "node": "reddit - advertising",
            "type": "main",
            "index": 0
          },
          {
            "node": "reddit - marketing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "campaignlive - news": {
      "main": [
        [
          {
            "node": "Merge RSS Sources",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "adweek": {
      "main": [
        [
          {
            "node": "Merge RSS Sources",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "campaignlive - latest": {
      "main": [
        [
          {
            "node": "Merge RSS Sources",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "reddit - advertising": {
      "main": [
        [
          {
            "node": "Merge RSS Sources",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "reddit - marketing": {
      "main": [
        [
          {
            "node": "Merge RSS Sources",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Generate an image": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Code": {
      "main": [
        []
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Prepare API Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Prepare API Data": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "Send Individual Trends to API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Individual Trends to API": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "cfdbc48c-280a-414c-89eb-040668e4e6b6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "35da76c3eaa1cbc2ecc4af2ce11b5301cbd1d6edd58a285384cc9e60d637dd8b"
  },
  "id": "LG3cXZGowLL0SIEK",
  "tags": []
}